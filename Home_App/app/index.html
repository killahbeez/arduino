<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Home App</title>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png"  href="favicon.ico" />
	<link rel="shortcut icon" type="image/png"  href="favicon.ico" />
	<link rel="apple-touch-icon" type="image/png"  href="favicon.ico" />
	<link rel="apple-touch-icon-precomposed" type="image/png"  href="favicon.ico" />
	
	
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css?v=4.2">
	<link rel="stylesheet" href="css/palette-color-picker.css?v=22">
	<link rel="stylesheet" href="css/ui.css?v=2.97">

    <script src="js/mqttws31.js" type="text/javascript"></script>
    <script src="js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="js/config.js?v=5.51" type="text/javascript"></script>

	<script src="js/jquery.mobile-1.4.5.min.js"></script>
	<script src="js/palette-color-picker.js?v=2.2"></script>

    <script type="text/javascript">
		var mqtt;
		var reconnectTimeout = 2000;

		function MQTTconnect() {

			if (typeof path == "undefined") {
				path = '/mqtt';
			}

			mqtt = new Paho.MQTT.Client(
					host,
					port,
					path,
					"web_1" + parseInt(Math.random() * 100, 10)
			);

			var options = {
				timeout: 3,
				useSSL: useTLS,
				cleanSession: cleansession,
				onSuccess: onConnect,
				onFailure: function (message) {
					$('#status').text("Connection failed: " + message.errorMessage + "Retrying");
					setTimeout(MQTTconnect, reconnectTimeout);
				}
			};

			mqtt.onConnectionLost = onConnectionLost;
			mqtt.onMessageArrived = onMessageArrived;

			if (username != null) {
				options.userName = username;
				options.password = password;
			}

			mqtt.connect(options);
		}

		function onConnect() {
			$('#status').text('Connected to ' + host + ':' + port + path);
			// Connection succeeded; subscribe to our topic
			mqtt.subscribe(topic, {qos: 1});
			$('#topic').text(topic);
		}

		function onConnectionLost(response) {
			setTimeout(MQTTconnect, reconnectTimeout);
			$('#status').text("connection lost: " + response.errorMessage + ". Reconnecting");

		};

		function onMessageArrived(message) {

			var topic = message.destinationName;
			
			var payload = message.payloadString;

			if(topic == topics.lampa.state){

				if(payload == 1){
					$("#lampa").prop('checked', true); 
					
				}
				else if (payload == 0){
					$("#lampa").prop('checked', false); 
				}
			}
			
			
			if(topic == topics.neopixel_1.state){
				var neopixel_commands = payload.split('#');
				if(neopixel_commands[0] == 'turn'){
					$("#neopixel_1")[0].checked = (neopixel_commands[1] == 1 ? true : false);
					$('#neopixel_1_color').data('paletteColorPickerPlugin').update("#"+neopixel_commands[2]);
					colors.neopixel_1 = "#"+neopixel_commands[2];
					$("#div_neopixel_1 .ui-slider-bg.ui-btn-active").css('background-color',colors.neopixel_1);
					
					$("#min_neopixel_1").text(neopixel_commands[3]);
					$("#max_neopixel_1").text(neopixel_commands[4]);
					$("#range_neopixel_1_max" ).val(neopixel_commands[4]).slider( "refresh" );
					$("#range_neopixel_1_min" ).val(neopixel_commands[3]).slider( "refresh" );
					range.neopixel_1.min = neopixel_commands[3];
					range.neopixel_1.max = neopixel_commands[4];
				}				
			}
			
			if(topic == topics.neopixel_2.state){
				var neopixel_commands = payload.split('#');
				if(neopixel_commands[0] == 'turn'){
					$("#neopixel_2")[0].checked = (neopixel_commands[1] == 1 ? true : false);
					$('#neopixel_2_color').data('paletteColorPickerPlugin').update("#"+neopixel_commands[2]);
					colors.neopixel_2 = "#"+neopixel_commands[2];
					$("#div_neopixel_2 .ui-slider-bg.ui-btn-active").css('background-color',colors.neopixel_2);
					
					$("#min_neopixel_2").text(neopixel_commands[3]);
					$("#max_neopixel_2").text(neopixel_commands[4]);
					$("#range_neopixel_2_max" ).val(neopixel_commands[4]).slider( "refresh" );
					$("#range_neopixel_2_min" ).val(neopixel_commands[3]).slider( "refresh" );
					range.neopixel_2.min = neopixel_commands[3];
					range.neopixel_2.max = neopixel_commands[4];
				}				
			}

			if(topic == topics.neopixel_3.state){
				var neopixel_commands = payload.split('#');
				// ["turn", "0", "0000FF" , "1", "8"]
				if(neopixel_commands[0] == 'turn'){
					$("#neopixel_3")[0].checked = (neopixel_commands[1] == 1 ? true : false);
					$('#neopixel_3_color').data('paletteColorPickerPlugin').update("#"+neopixel_commands[2]);
					colors.neopixel_3 = "#"+neopixel_commands[2];
					$("#div_neopixel_3 .ui-slider-bg.ui-btn-active").css('background-color',colors.neopixel_3);
					
					$("#min_neopixel_3").text(neopixel_commands[3]);
					$("#max_neopixel_3").text(neopixel_commands[4]);
					$("#range_neopixel_3_max" ).val(neopixel_commands[4]).slider( "refresh" );
					$("#range_neopixel_3_min" ).val(neopixel_commands[3]).slider( "refresh" );
					range.neopixel_3.min = neopixel_commands[3];
					range.neopixel_3.max = neopixel_commands[4];
				}				
			}

			if(topic == topics.neopixel_1.stateDim){
				$("#dim_neopixel_1").text(payload);
				$("#slider_neopixel_1").val(payload).slider( "refresh" );
			}

			if(topic == topics.neopixel_2.stateDim){
				$("#dim_neopixel_2").text(payload);
				$("#slider_neopixel_2").val(payload).slider( "refresh" );
			}

			if(topic == topics.neopixel_3.stateDim){
				$("#dim_neopixel_3").text(payload);
				$("#slider_neopixel_3").val(payload).slider( "refresh" );
			}
			
			if(topic == topics.debug){
				if(payload){
					$("#debug").prepend(payload+'<br />'); 
				}
			}

			
			if(topic == "/home/didi"){
				$("#didi").text(payload);
			}
			
			//$('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
			
		};

		</script>
		<script type="text/javascript">
			$(document).ready(function() {
				MQTTconnect();


				$( "#lampa" ).on( "change", function() {
					if($(this).is(':checked')){
						var message = new Paho.MQTT.Message("1#Lamp ON");
						message.destinationName = topics.lampa.command;
						message.retained = true;
						mqtt.send(message);
					}
					else{
						var message = new Paho.MQTT.Message("0#Lamp OFF");
						message.destinationName = topics.lampa.command;
						message.retained = true;
						mqtt.send(message);

					}
					
				});
				
				$( "#neopixel_1" ).on( "change", function() {
					publish_MQTT_neopixel("neopixel_1");
				});
				
				$('#neopixel_1_color').paletteColorPicker({
					insert: 'after',
					timeout: 1500,
					clear_btn: null
				});

				$('#neopixel_1_color').data('paletteColorPickerPlugin').clicked = function(el){
					colors.neopixel_1 = $(el).attr('data-color');
					publish_MQTT_neopixel("neopixel_1");
				};
				
				$( "#slider_neopixel_1" ).on( "slidestop", function() {
					$("#slider_neopixel_1").slider( "refresh" );
					var message = new Paho.MQTT.Message($(this).val());
					message.destinationName = topics.neopixel_1.commandDim;
					message.retained = true;
					mqtt.send(message);
				});

				$( "#slider_neopixel_1" ).on( "change", function() {
					$("#dim_neopixel_1").text($(this).val());
				});

				$( "#range_neopixel_1" ).on( "change", function() {
					$("#min_neopixel_1").text($("#range_neopixel_1_min").val());
					$("#max_neopixel_1").text($("#range_neopixel_1_max").val());
				});

				$( "#range_neopixel_1" ).on( "slidestop", function() {
					range.neopixel_1.min = $("#range_neopixel_1_min").val();
					range.neopixel_1.max = $("#range_neopixel_1_max").val();
					
					publish_MQTT_neopixel("neopixel_1");
				});

				$( "#neopixel_2" ).on( "change", function() {
					publish_MQTT_neopixel("neopixel_2");
				});
				
				$('#neopixel_2_color').paletteColorPicker({
					insert: 'after',
					timeout: 1500,
					clear_btn: null
				});

				$('#neopixel_2_color').data('paletteColorPickerPlugin').clicked = function(el){
					colors.neopixel_2 = $(el).attr('data-color');
					publish_MQTT_neopixel("neopixel_2");
				};

				$( "#slider_neopixel_2" ).on( "slidestop", function() {
					$("#slider_neopixel_2").slider( "refresh" );
					var message = new Paho.MQTT.Message($(this).val());
					message.destinationName = topics.neopixel_2.commandDim;
					message.retained = true;
					mqtt.send(message);
				});

				$( "#slider_neopixel_2" ).on( "change", function() {
					$("#dim_neopixel_2").text($(this).val());
				});

				$( "#range_neopixel_2" ).on( "change", function() {
					$("#min_neopixel_2").text($("#range_neopixel_2_min").val());
					$("#max_neopixel_2").text($("#range_neopixel_2_max").val());
				});

				$( "#range_neopixel_2" ).on( "slidestop", function() {
					range.neopixel_2.min = $("#range_neopixel_2_min").val();
					range.neopixel_2.max = $("#range_neopixel_2_max").val();
					
					publish_MQTT_neopixel("neopixel_2");
				});
				

				$( "#neopixel_3" ).on( "change", function() {
					publish_MQTT_neopixel("neopixel_3");
				});
				
				$('#neopixel_3_color').paletteColorPicker({
					insert: 'after',
					timeout: 1500,
					clear_btn: null
				});

				$('#neopixel_3_color').data('paletteColorPickerPlugin').clicked = function(el){
					colors.neopixel_3 = $(el).attr('data-color');
					publish_MQTT_neopixel("neopixel_3");
				};

				$( "#slider_neopixel_3" ).on( "slidestop", function() {
					$("#slider_neopixel_3").slider( "refresh" );
					var message = new Paho.MQTT.Message($(this).val());
					message.destinationName = topics.neopixel_3.commandDim;
					message.retained = true;
					mqtt.send(message);
				});

				$( "#slider_neopixel_3" ).on( "change", function() {
					$("#dim_neopixel_3").text($(this).val());
				});

				$( "#range_neopixel_3" ).on( "change", function() {
					$("#min_neopixel_3").text($("#range_neopixel_3_min").val());
					$("#max_neopixel_3").text($("#range_neopixel_3_max").val());
				});

				$( "#range_neopixel_3" ).on( "slidestop", function() {
					range.neopixel_3.min = $("#range_neopixel_3_min").val();
					range.neopixel_3.max = $("#range_neopixel_3_max").val();
					
					publish_MQTT_neopixel("neopixel_3");
				});

			});

			function publish_MQTT_neopixel(nr){
				
				var message = new Paho.MQTT.Message("turn#" + ($("#"+nr).is(":checked")|0) + eval("colors."+nr) + "#" + eval("range."+nr+".min") + "#" + eval("range."+nr+".max"));
					message.destinationName = eval("topics."+nr+".command");
					message.retained = true;
					mqtt.send(message);
				
				console.log("turn#" + ($("#"+nr).is(":checked")|0) + eval("colors."+nr) + "#" + eval("range."+nr+".min") + "#" + eval("range."+nr+".max"));
			}
		</script>
  </head>
  <body>
	<div style="margin:0px 10px 0px 10px;">
		<div style="margin-bottom:5px;">
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:80px;">
				Lampa
			</div>
			<div style="display:inline-block;vertical-align: middle;margin:0px 10px 0px 10px;">
				<label class="switch">
					<input type="checkbox" id="lampa" class="switch-input" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle"></span>
				</label>
			</div>
		</div>
		<div id="div_neopixel_1" style="margin-bottom:20px;">
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:80px;">
				Led geam
			</div>
			<div style="display:inline-block;vertical-align: middle;margin:0px 10px 0px 10px;">
				<label class="switch">
					<input type="checkbox" id="neopixel_1" name="neopixel_1" class="switch-input" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle"></span>
				</label>
			</div>
			<div style="display:inline-block;vertical-align: middle;">
				<input type="text" id="neopixel_1_color" name="neopixel_1_color" data-palette='["#FF0000","#FF6600","#FF9300","#FFC600","#FEFE00","#8CC600",
								"#0EAC00","#00A2C0","#0061B5","#0011A4","#6300A5","#C5007B",
								"#FFFFFF"]' value="#ffffff" style="display:none;" data-role="none">
			</div>

			
			<div style="position:relative;">
				<div class="dimValue">Dim: <span id="dim_neopixel_1">0</span></div>
				<div style="position:relative;margin-top:10px;">	
					<input name="slider_neopixel_1" id="slider_neopixel_1" data-highlight="true" min="1" max="200" value="0" type="range" style="display:none;">
				</div>
			</div>
			<div style="position:relative;">
				<div class="dimValue"><span id="min_neopixel_1">1</span> &#247; <span id="max_neopixel_1">64</span></div>
				<div style="position:relative;margin-left:20px;margin-right:-50px;">
					<div id="range_neopixel_1" data-role="rangeslider" class="range_neopixel">
						<input name="range_neopixel_1_min" id="range_neopixel_1_min" min="1" max="68" value="1" type="range" style="display:none;" />
						<input name="range_neopixel_1_max" id="range_neopixel_1_max" min="1" max="68" value="68" type="range" style="display:none;" />
					</div>
				</div>
			</div>

		</div>
		<div id="div_neopixel_2" style="margin-bottom:20px;">
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:80px;">
				Led scule
			</div>
			<div style="display:inline-block;vertical-align: middle;margin:0px 10px 0px 10px;">
				<label class="switch">
					<input type="checkbox" id="neopixel_2" name="neopixel_2" class="switch-input" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle"></span>
				</label>
			</div>
			<div style="display:inline-block;vertical-align: middle;">
				<input type="text" id="neopixel_2_color" name="neopixel_2_color" data-palette='["#FF0000","#FF6600","#FF9300","#FFC600","#FEFE00","#8CC600",
								"#0EAC00","#00A2C0","#0061B5","#0011A4","#6300A5","#C5007B",
								"#FFFFFF"]' value="#ffffff" style="display:none;" data-role="none">
			</div>


			<div style="position:relative;">
				<div class="dimValue">Dim: <span id="dim_neopixel_2">0</span></div>
				<div style="position:relative;margin-top:10px;">	
					<input name="slider_neopixel_2" id="slider_neopixel_2" data-highlight="true" min="1" max="200" value="0" type="range" style="display:none;">
				</div>
			</div>
			
			<div style="position:relative;">
				<div class="dimValue"><span id="min_neopixel_2">1</span> &#247; <span id="max_neopixel_2">26</span></div>
				<div style="position:relative;margin-left:20px;margin-right:-50px;">
					<div id="range_neopixel_2" data-role="rangeslider" class="range_neopixel">
						<input name="range_neopixel_2_min" id="range_neopixel_2_min" min="1" max="26" value="1" type="range" style="display:none;" />
						<input name="range_neopixel_2_max" id="range_neopixel_2_max" min="1" max="26" value="26" type="range" style="display:none;" />
					</div>
				</div>
			</div>
		</div>

		<div id="div_neopixel_3">
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:80px;">
				Led comoda
			</div>
			<div style="display:inline-block;vertical-align: middle;margin:0px 10px 0px 10px;">
				<label class="switch">
					<input type="checkbox" id="neopixel_3" name="neopixel_3" class="switch-input" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle"></span>
				</label>
			</div>
			<div style="display:inline-block;vertical-align: middle;">
				<input type="text" id="neopixel_3_color" name="neopixel_3_color" data-palette='["#FF0000","#FF6600","#FF9300","#FFC600","#FEFE00","#8CC600",
								"#0EAC00","#00A2C0","#0061B5","#0011A4","#6300A5","#C5007B",
								"#FFFFFF"]' value="#ffffff" style="display:none;" data-role="none">
			</div>

			<div style="position:relative;">
				<div class="dimValue">Dim: <span id="dim_neopixel_3">0</span></div>
				<div style="position:relative;margin-top:10px;">	
					<input name="slider_neopixel_3" id="slider_neopixel_3" data-highlight="true" min="1" max="200" value="0" type="range" style="display:none;">
				</div>
			</div>
			<div style="position:relative;">
				<div class="dimValue"><span id="min_neopixel_3">1</span> &#247; <span id="max_neopixel_3">40</span></div>
				<div style="position:relative;margin-left:20px;margin-right:-50px;">
					<div id="range_neopixel_3" data-role="rangeslider" class="range_neopixel">
						<input name="range_neopixel_3_min" id="range_neopixel_3_min" min="1" max="40" value="1" type="range" style="display:none;" />
						<input name="range_neopixel_3_max" id="range_neopixel_3_max" min="1" max="40" value="40" type="range" style="display:none;" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="debug" style="margin:10px 10px 10px 10px;height:100px;overflow:auto;"></div>

	
	<div id="didi" style="height:100px;overflow:auto;"></div>
	
	<!--
	<div>
		<h1>Mosquitto Websockets</h1>
		<div>
			<div>
				<div style="display:inline;">Subscribed to: </div><div id="topic" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>
			<div>
				<div style="display:inline;">Status: </div><div id="status" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>

			<ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
		</div>
	</div>
	-->
  </body>
</html>
