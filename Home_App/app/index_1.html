
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
	<link rel="stylesheet" href="_assets/css/jqm-demos.css">

	
    <script src="js/mqttws31.js" type="text/javascript"></script>
    <script src="js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="js/config.js" type="text/javascript"></script>

	
	<script src="_assets/js/index.js"></script>
	<!--<script src="js/jquery.mobile-1.4.5.js"></script>-->



    <script type="text/javascript">
    var mqtt;
    var reconnectTimeout = 2000;

    function MQTTconnect() {

		if (typeof path == "undefined") {
			path = '/mqtt';
		}

		mqtt = new Paho.MQTT.Client(
				host,
				port,
				path,
				"web_1" + parseInt(Math.random() * 100, 10)
		);

		var options = {
			timeout: 3,
			useSSL: useTLS,
			cleanSession: cleansession,
			onSuccess: onConnect,
			onFailure: function (message) {
				$('#status').text("Connection failed: " + message.errorMessage + "Retrying");
				setTimeout(MQTTconnect, reconnectTimeout);
			}
		};

		mqtt.onConnectionLost = onConnectionLost;
		mqtt.onMessageArrived = onMessageArrived;

		if (username != null) {
			options.userName = username;
			options.password = password;
		}

		console.log("Host="+ host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);

		mqtt.connect(options);
    }

    function onConnect() {
        $('#status').text('Connected to ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 1});
        $('#topic').text(topic);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').text("connection lost: " + response.errorMessage + ". Reconnecting");

    };

    function onMessageArrived(message) {

        var topic = message.destinationName;
		
        var payload = message.payloadString;
		if(topic == topics.lampa.state){
			console.log(topics.lampa.state);
			console.log(payload);

			if(payload == 1){
				$("#lampa").val("on");
				//$("#lampa option[value='on']").attr('selected', 'selected'); 
				//$( "#lampa" ).selectmenu("refresh");
				
			}
			else if (payload == 0){
				$("#lampa").val("off");
				//$("#lampa option[value='off']").attr('selected', 'selected'); 
				//$( "#lampa" ).selectmenu().selectmenu("refresh");
			}
		}

		
		if(topic == topics.debug){
			if(payload){
				$("#debug").text(payload); 
			}
		}
        //$('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
		
    };


    $(document).ready(function() {
        MQTTconnect();
    });

    </script>
	<script type="text/javascript">
	$(document).ready(function() {
		$( "#lampa" ).on( "change", function() {
			if(this.value == "on"){
				var message = new Paho.MQTT.Message("{'command':1,'debug':'Lamp is ON'}");
				message.destinationName = topics.lampa.command;
				message.retained = true;
				
				mqtt.send(message);
			}
			else if(this.value == "off"){
				var message = new Paho.MQTT.Message("{'command':0,'debug':'Lamp is OFF'}");
				message.destinationName = topics.lampa.command;
				message.retained = true;
				mqtt.send(message);

			}
			
		});

		
	});
	</script>
  </head>
  <body>
	<form>
		<label for="lampa">Flip toggle switch:</label><!--flipswitch-->
		<select name="lampa" id="lampa" data-role="flipswitch" data-mini="true">
			<option value="off">Off</option>
			<option value="on">On</option>
		</select>
	</form>
	<div id="debug" style="border:1px solid black;"></div>
	<!--
	<div>
		<h1>Mosquitto Websockets</h1>
		<div>
			<div>
				<div style="display:inline;">Subscribed to: </div><div id="topic" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>
			<div>
				<div style="display:inline;">Status: </div><div id="status" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>

			<ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
		</div>
	</div>
	-->
  </body>
</html>