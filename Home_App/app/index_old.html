<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Home App</title>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png"  href="favicon.ico" />
	<link rel="shortcut icon" type="image/png"  href="favicon.ico" />
	<link rel="apple-touch-icon" type="image/png"  href="favicon.ico" />
	<link rel="apple-touch-icon-precomposed" type="image/png"  href="favicon.ico" />
	
	
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css?v=3">
	<link rel="stylesheet" href="css/ui.css?v=4.21">

    <script src="js/mqttws31.js" type="text/javascript"></script>
    <script src="js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="js/config.js?v=4.1" type="text/javascript"></script>

	<script src="js/jquery.mobile-1.4.5.min.js"></script>

    <script type="text/javascript">
		var mqtt;
		var reconnectTimeout = 2000;

		function MQTTconnect() {

			if (typeof path == "undefined") {
				path = '/mqtt';
			}

			mqtt = new Paho.MQTT.Client(
					host,
					port,
					path,
					"web_1" + parseInt(Math.random() * 100, 10)
			);

			var options = {
				timeout: 3,
				useSSL: useTLS,
				cleanSession: cleansession,
				onSuccess: onConnect,
				onFailure: function (message) {
					$('#status').text("Connection failed: " + message.errorMessage + "Retrying");
					setTimeout(MQTTconnect, reconnectTimeout);
				}
			};

			mqtt.onConnectionLost = onConnectionLost;
			mqtt.onMessageArrived = onMessageArrived;

			if (username != null) {
				options.userName = username;
				options.password = password;
			}

			mqtt.connect(options);
		}

		function onConnect() {
			$('#status').text('Connected to ' + host + ':' + port + path);
			// Connection succeeded; subscribe to our topic
			mqtt.subscribe(topic, {qos: 1});
			$('#topic').text(topic);
		}

		function onConnectionLost(response) {
			setTimeout(MQTTconnect, reconnectTimeout);
			$('#status').text("connection lost: " + response.errorMessage + ". Reconnecting");

		};

		function onMessageArrived(message) {

			var topic = message.destinationName;
			
			var payload = message.payloadString;

			if(topic == topics.lampa.state){

				if(payload == 1){
					$("#lampa").prop('checked', true); 
					
				}
				else if (payload == 0){
					$("#lampa").prop('checked', false); 
				}
			}
			
			
			if(topic == topics.neopixel.state){
					
				var neopixel_commands = payload.split('#');
				//console.log(neopixel_commands);
				if(neopixel_commands[0] == 'turn'){
					for(var i=0;i<$( ".neopixel_color" ).length;i++){
						$(".neopixel_color")[i].checked = false;
						if($(".neopixel_color")[i].getAttribute("attr") == neopixel_commands[2]){
							$(".neopixel_color")[i].checked = (neopixel_commands[1] == 1 ? true : false);
						}
					}
				}				
			}

			if(topic == topics.neopixel.stateDim){
				$("#dimValue").text(payload);
				$("#slider").val(payload).slider( "refresh" );
			}

			
			if(topic == topics.debug){
				if(payload){
					$("#debug").prepend(payload+'<br />'); 
				}
			}

			
			if(topic == "/home/didi"){
				$("#didi").text(payload);
			}
			
			//$('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
			
		};


		$(document).ready(function() {
			MQTTconnect();
		});

		</script>
		<script type="text/javascript">
		$(document).ready(function() {
			$( "#lampa" ).on( "change", function() {
				if($(this).is(':checked')){
					var message = new Paho.MQTT.Message("1#Lamp ON");
					message.destinationName = topics.lampa.command;
					message.retained = true;
					mqtt.send(message);
				}
				else{
					var message = new Paho.MQTT.Message("0#Lamp OFF");
					message.destinationName = topics.lampa.command;
					message.retained = true;
					mqtt.send(message);

				}
				
			});
			
			$( ".neopixel_color" ).on( "change", function() {
				var is_checked = $(this).is(":checked") ? true : false;
				
				for(var i=0;i<$( ".neopixel_color" ).length;i++){
					$(".neopixel_color")[i].checked=false;
				}

				$(this).prop('checked',(is_checked ? true : false));

				var message = new Paho.MQTT.Message("turn#" + ($(this).is(":checked")|0) +"#" + $(this)[0].getAttribute('attr'));
				message.destinationName = topics.neopixel.command;
				message.retained = true;
				mqtt.send(message);

				
				//console.log("turn#" + ($(this).is(":checked")|0) +"#" + $(this)[0].getAttribute('attr'));
			});
			
			
			$( "#slider" ).on( "slidestop", function() {
				$("#slider").slider( "refresh" );
				var message = new Paho.MQTT.Message($(this).val());
				message.destinationName = topics.neopixel.commandDim;
				message.retained = true;
				mqtt.send(message);
			});

			$( "#slider" ).on( "change", function() {
				$("#dimValue").text($(this).val());
			});
		});
	</script>
  </head>
  <body>
	<div style="margin:0px 10px 0px 10px;">
		<div style="margin-bottom:5px;">
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:70px;">
				Lamp
			</div>
			<div style="display:inline-block;vertical-align: middle;">
				<label class="switch">
					<input type="checkbox" id="lampa" class="switch-input" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle"></span>
				</label>
			</div>
		</div>
		<div>
			<div style="display:inline-block;vertical-align: middle;font-weight:bold;width:70px;">
				Neopixel
			</div>
			<div style="display:inline-block;vertical-align: middle;">
				<label class="switch">
					<input type="checkbox" id="neopixel_red" attr="R" class="switch-input neopixel_color" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle" style="background:red;"></span>
				</label>
				<label class="switch">
					<input type="checkbox" id="neopixel_green" attr="G" class="switch-input neopixel_color" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle" style="background:green;"></span>
				</label>
				<label class="switch">
					<input type="checkbox" id="neopixel_blue" attr="B" class="switch-input neopixel_color" data-role="none">
					<span class="switch-trough" data-on="On" data-off="Off"></span>
					<span class="switch-handle" style="background:blue;"></span>
					
				</label>
			</div>

			<div style="position:relative;">	
				<div class="dimValue">
					Dim: <span id="dimValue"></span>
				</div>
				<input name="slider" id="slider" data-highlight="true" min="1" max="200" value="0" type="range" style="display:none;">
			</div>
		</div>
	</div>
	<div id="debug" style="margin:10px 10px 10px 10px;height:100px;overflow:auto;"></div>

	
	<div id="didi" style="height:100px;overflow:auto;"></div>
	
	<!--
	<div>
		<h1>Mosquitto Websockets</h1>
		<div>
			<div>
				<div style="display:inline;">Subscribed to: </div><div id="topic" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>
			<div>
				<div style="display:inline;">Status: </div><div id="status" style="background:#eeeeee;display:inline;font-weight: bold;"> </div>
			</div>

			<ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
		</div>
	</div>
	-->
  </body>
</html>
